#!/bin/bash -x

# c++ (cquery)
function lsp_cpp () {
    pushd ~/wa/git

    if [ ! -e cquery ] ; then
        git rclone https://github.com/cquery-project/cquery.git
    else
        pushd cquery
        git pull
        git sub-update
        popd
    fi

    mkdir -p cquery/build

    pushd cquery/build

    if [ ! -e CMakeCache.txt ] ; then
        local_cmake ..
    fi

    make
    make install

    popd

    popd
}

# python
function lsp_python () {
    # TODO: certificates
    pip install --user 'python-language-server[all]'
    # also install debug server
    pip install --user 'ptvsd>=4.1.1a11'
}

# Go
function lsp_go () {
    go get -u github.com/sourcegraph/go-langserver
}

# Java
function lsp_java () {
    if [ ! -e ~/.emacs.d/eclipse.jdt.ls/server ] ; then
        rm -f /tmp/jdt-latest.tar
        # NOTE: can't use -c because this file changes
        wget http://download.eclipse.org/jdtls/snapshots/jdt-language-server-latest.tar.gz -O /tmp/jdt-latest.tar
        mkdir -p ~/.emacs.d/eclipse.jdt.ls/server/
        tar xf /tmp/jdt-latest.tar -C ~/.emacs.d/eclipse.jdt.ls/server/
        rm -f /tmp/jdt-latest.tar
    else
        echo "Java LS already installed, update inside emacs with M-x lsp-java-update-server"
    fi
}

# Rust
function lsp_rust () {
    if type yum ; then
        sudo yum install -y rls-preview rust-analysis rust-src
    else
        curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path
        source $HOME/.cargo/env
        rustup component add rls-preview rust-analysis rust-src
    fi
}

# Javascript
function lsp_js () {
    sudo npm i -g javascript-typescript-langserver
}

# HTML
function lsp_html () {
    sudo npm i -g vscode-html-languageserver-bin
}

# Run each section
lsp_cpp
lsp_python
lsp_go
lsp_java
lsp_rust
lsp_js
lsp_html
