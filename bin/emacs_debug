#!/usr/bin/env python

import sys
import os
import os.path
import emacsproject.config

#Sample config (.emacs_project.json)
#{
#    "debug": {
#        "program": "executable",
#        "program_args": "args",
#        "working_dir": "build-debug"
#    }
#}

config_dir = emacsproject.config.getConfigDir()

if config_dir == "":
    print "Unable to find .emacs_project.json"
    sys.exit(1)

# Read config file
config = emacsproject.config.loadJsonFile(config_dir + os.sep + ".emacs_project.json")

working_dir = config['debug'].get('working_dir', '.')

gdb_command = config['debug'].get('gdb', 'gdb')
gdb_args = config['debug'].get('gdb_args', '')

program = config['debug']['program']
program_args = config['debug'].get('program_args', '')

command = gdb_command + " " + gdb_args + " -i=mi --args " + program + " " + program_args

# For debugging (can't actually print anything out or else it will mess up emacs)
#print "Running: " + command

# Run debug command
os.chdir(config_dir + os.sep + working_dir)
ret = os.WEXITSTATUS(os.system(command))
sys.exit(ret)
